name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  release:
    types: [ created ]

env:
  BUILD_TYPE: releasedbg

jobs:
  build:
    name: Build
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup xmake
      uses: xmake-io/github-action-setup-xmake@v1
      with:
        xmake-version: latest
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
    
    - name: Configure xmake
      run: |
        xmake config -m ${{ env.BUILD_TYPE }} -y
    
    - name: Build
      run: |
        xmake build -y -v
    
    - name: List providers
      run: |
        xmake r cli-new --list
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kdu-build-${{ github.sha }}
        path: |
          build/windows/x64/${{ env.BUILD_TYPE }}/*.exe
          build/windows/x64/${{ env.BUILD_TYPE }}/*.lib
          build/windows/x64/${{ env.BUILD_TYPE }}/*.sys
        retention-days: 30
    
    - name: Upload to nightly (on push to main)
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: actions/upload-artifact@v4
      with:
        name: kdu-nightly
        path: |
          build/windows/x64/${{ env.BUILD_TYPE }}/cli-new.exe
          build/windows/x64/${{ env.BUILD_TYPE }}/provider-tests.exe
        retention-days: 90
    
    - name: Create Release Assets
      if: github.event_name == 'release'
      run: |
        cd build/windows/x64/${{ env.BUILD_TYPE }}
        7z a -tzip kdu-${{ github.event.release.tag_name }}-windows-x64.zip *.exe *.sys
    
    - name: Upload Release Assets
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: build/windows/x64/${{ env.BUILD_TYPE }}/kdu-${{ github.event.release.tag_name }}-windows-x64.zip
        asset_name: kdu-${{ github.event.release.tag_name }}-windows-x64.zip
        asset_content_type: application/zip

test-providers:
    name: Test Provider - ${{ matrix.provider }}
    needs: build
    runs-on: windows-latest
    if: github.event_name != 'release'
    strategy:
      fail-fast: false
      matrix:
        provider: [gdrv, asrock, asrock2, asrock3, asrock4, asrock5]
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: kdu-build-${{ github.sha }}
        path: build
    
    - name: Run tests
      continue-on-error: true
      timeout-minutes: 5
      run: |
        cd build
        ./provider-tests.exe ${{ matrix.provider }}